{"version":3,"sources":["../../../lib/ai/prompts/surgeon-assessment.ts"],"sourcesContent":["/**\n * 生成「二位心脏外科专科医师判定」文件的 Prompt\n */\n\nexport function generateSurgeonAssessmentPrompt(caseData: any) {\n  const systemPrompt = `你是一位专业的医疗文书助理，专门协助撰写 TAVI（经导管主动脉瓣膜置换术）健保事前审查申请文件中的「病患摘要段落」。\n\n你的任务是根据提供的病患资料，生成一个**单一段落**的专业医疗摘要，用于「二位心脏外科专科医师判定」文件。\n\n**格式要求：**\n1. 必须是**单一段落**，不分段\n2. 使用繁体中文，专业医学用语\n3. 按照以下顺序组织内容：\n   - 个案基本资料（姓名、病历号、性别、年龄、出生日期、身份证号）\n   - History（病史，使用医学英文缩写，用顿号分隔）\n   - 就医历程与症状发展（时间序列叙述）\n   - 重要检查结果摘要（心脏超音波、心导管等）\n   - 外科医师评估（STS score、两位医师姓名）\n   - 日常生活功能状态\n   - 存活机率评估\n   - 手术适应症与紧急性说明\n   - 结尾：请求健保局同意\n\n**范例格式参考：**\n\"个案: [姓名] [病历号]（[性别]）[年龄] 岁 [出生日期], [身份证号]；History：[病史1]、[病史2]、[病史3]，在[追踪地点]追踪。[症状发生时间]开始感[症状]的情形、[就医时间]因[症状]加剧至[地点]就医。于 [日期] 安排心导管检查: [结果摘要]。于 [日期] 心脏超音波：[关键数据]。[近期病情发展]，经二位心脏外科专科医师([医师1],[医师2])评估(STS score >10%)传统手术风险高；病患平时日常生活[功能状态]，临床上判定病人至少有一年以上之存活机率。医病共享决策与家属讨论后决定申请经导管主动脉瓣膜置换手术(TAVI)来改善的症状。由于主动脉瓣膜狭窄的情形(Critical AS) 随时都有猝死的可能，需尽快施行经导管主动脉瓣膜置换术(TAVI)来改善的症状，惠请贵局同意。\"\n\n**注意事项：**\n- 所有日期使用民国年格式（例如 114/04/21）\n- 医学术语保持英文（如 Severe AS, LVEF, CAD 等）\n- 数据要精确（如 AVA:0.67cm2, LVEF:32%）\n- 语气专业、客观、简洁\n- 强调 Critical AS 的紧急性`;\n\n  const userPrompt = buildUserPrompt(caseData);\n\n  return { systemPrompt, userPrompt };\n}\n\nfunction buildUserPrompt(caseData: any): string {\n  const { patient, medicalHistory, customHistory, symptoms, customSymptoms, symptomOnset, clinicalCourse, examinations, riskAssessment } = caseData;\n\n  // 1. 基本资料\n  const patientInfo = `\n个案基本资料：\n- 姓名：${patient.name}\n- 病历号：${patient.chartNumber}\n- 性别：${patient.gender === 'male' ? '男' : '女'}\n- 出生日期：${patient.birthDate}（${calculateAge(patient.birthDate)} 岁）\n- 身份证号：${patient.nationalId || '无'}\n`;\n\n  // 2. 病史\n  const historyList = [...medicalHistory];\n  if (customHistory) historyList.push(customHistory);\n  const history = `\n病史 (History)：\n${historyList.join('、')}\n`;\n\n  // 3. 症状\n  const symptomsList = [...symptoms];\n  if (customSymptoms) symptomsList.push(customSymptoms);\n  const symptomsInfo = `\n症状：\n${symptomsList.join('、')}\n症状发生时间：${symptomOnset || '无记录'}\n`;\n\n  // 4. 就医历程\n  const clinicalInfo = `\n就医历程：\n- 原追踪地点：${clinicalCourse.previousCare || '无记录'}\n- 就医经过：${clinicalCourse.presentation || '无记录'}\n`;\n\n  // 5. 检查报告摘要\n  const examinationsInfo = examinations.map((exam: any) => {\n    let summary = `\\n${getExaminationTypeName(exam.type)}：`;\n    if (exam.date) summary += `日期 ${exam.date}`;\n    if (exam.textContent) summary += `\\n${exam.textContent.substring(0, 200)}...`; // 取前200字\n    if (exam.extractedData) {\n      summary += `\\n关键数据：${JSON.stringify(exam.extractedData)}`;\n    }\n    return summary;\n  }).join('\\n');\n\n  // 6. 风险评估\n  const riskInfo = `\n手术风险评估：\n- STS Score：${riskAssessment.stsScore || '无记录'}\n- 第一位心脏外科医师：${riskAssessment.surgeon1 || '无'}\n- 第二位心脏外科医师：${riskAssessment.surgeon2 || '无'}\n- NYHA 心功能分级：${riskAssessment.nyhaClass || '无'}\n- 手术适应症与紧急性：${riskAssessment.urgencyReason || '无'}\n`;\n\n  // 组合完整的 user prompt\n  return `\n请根据以下病患资料，生成一个**单一段落**的 TAVI 事前审查摘要：\n\n${patientInfo}\n${history}\n${symptomsInfo}\n${clinicalInfo}\n${examinationsInfo}\n${riskInfo}\n\n**重要提示：**\n1. 请生成**单一段落**，不要分段\n2. 按照范例格式组织内容\n3. 所有日期转换为民国年格式\n4. 保持医学术语的英文缩写\n5. 强调 Critical AS 的紧急性，需尽快手术\n6. 结尾请写：「惠请贵局同意。」\n\n请开始生成：\n`;\n}\n\n// 辅助函数：计算年龄\nfunction calculateAge(birthDate: string): number {\n  const birth = new Date(birthDate);\n  const today = new Date();\n  let age = today.getFullYear() - birth.getFullYear();\n  const monthDiff = today.getMonth() - birth.getMonth();\n  if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birth.getDate())) {\n    age--;\n  }\n  return age;\n}\n\n// 辅助函数：获取检查类型中文名称\nfunction getExaminationTypeName(type: string): string {\n  const typeMap: { [key: string]: string } = {\n    'echocardiography': '心脏超音波检查',\n    'catheterization': '心导管检查',\n    'ekg': '心电图 (EKG)',\n    'chest-xray': '胸部 X 光 (CXR)',\n    'pulmonary-function': '肺功能检查',\n    'abi': '四肢血流探测 (ABI)',\n    'heart-ct': 'Heart CT',\n    'myocardial-perfusion-scan': '心肌灌注扫描',\n    'vital-signs': '生理测量',\n    'lab-report': '检验报告',\n    'medical-record': '就医纪录',\n    'medication-record': '就医用药',\n    'list-of-diagnosis': 'List of Diagnosis',\n    'assessment-and-plan': 'Assessment and Plan',\n    'sts-score': 'STS Score',\n  };\n  return typeMap[type] || type;\n}\n"],"names":[],"mappings":"uCAIO,SAAS,EAAgC,CAAa,EA+B3D,MAAO,CAAE,aA9BY,CAAC;;;;;;;;;;;;;;;;;;;;;;;;;;qBA0BH,CAAC,CAIG,WAGzB,AALqB,SAKZ,AAAgB,CAAa,EACpC,IAkFM,EACA,EACF,EACE,EArFA,SAAE,CAAO,gBAAE,CAAc,eAAE,CAAa,CAAE,UAAQ,gBAAE,CAAc,CAAE,cAAY,gBAAE,CAAc,cAAE,CAAY,gBAAE,CAAc,CAAE,CAAG,EAGnI,EAAc,CAAC;;KAElB,EAAE,EAAQ,IAAI,CAAC;MACd,EAAE,EAAQ,WAAW,CAAC;KACvB,EAAqB,SAAnB,EAAQ,MAAM,CAAc,IAAM,IAAI;OACtC,EAAE,EAAQ,SAAS,CAAC,CAAC,EAAE,GA0Ed,IAAI,KA1EuB,AA0ElB,EA1E0B,SAAS,IA4EhD,GADI,IAAI,MACF,WAAW,GAAK,EAAM,WAAW,IAE7C,GADc,EAAM,QAAQ,GAAK,EAAM,QAAQ,IACnC,GAAoB,IAAd,GAAmB,EAAM,OAAO,GAAK,EAAM,OAAO,EAAA,GAAK,AAC3E,IAEK,GAjFqD;OACvD,EAAE,EAAQ,UAAU,EAAI,IAAI;AACnC,CAAC,CAGO,EAAc,IAAI,EAAe,CACnC,GAAe,EAAY,IAAI,CAAC,GACpC,IAAM,EAAU,CAAC;;AAEnB,EAAE,EAAY,IAAI,CAAC,KAAK;AACxB,CAAC,CAGO,EAAe,IAAI,EAAS,CAC9B,GAAgB,EAAa,IAAI,CAAC,GACtC,IAAM,EAAe,CAAC;;AAExB,EAAE,EAAa,IAAI,CAAC,KAAK;OAClB,EAAE,GAAgB,MAAM;AAC/B,CAAC,CAGO,EAAe,CAAC;;QAEhB,EAAE,EAAe,YAAY,EAAI,MAAM;OACxC,EAAE,EAAe,YAAY,EAAI,MAAM;AAC9C,CAAC,CAGO,EAAmB,EAAa,GAAG,CAAE,AAAD,UACxC,IAAI,EAAU,CAAC;AAAE,EAAE,AAwDsB,AAiBpC,CAhBL,iBAAoB,UACpB,gBAAmB,QACnB,IAAO,YACP,aAAc,eACd,qBAAsB,QACtB,IAAO,eACP,WAAY,WACZ,4BAA6B,SAC7B,cAAe,OACf,aAAc,OACd,iBAAkB,OAClB,oBAAqB,OACrB,oBAAqB,oBACrB,sBAAuB,sBACvB,YAAa,WACf,CACc,CAlBgB,AAkBf,EAzE6B,EAuDF,AAvDO,IAAI,CAyEjC,EAAI,EAzE+B,CAAC,CAAC,CAMvD,OALI,EAAK,IAAI,GAAE,GAAW,CAAC,GAAG,EAAE,EAAK,IAAI,CAAA,CAAA,AAAE,EACvC,EAAK,WAAW,GAAE,GAAW,CAAC;AAAE,EAAE,EAAK,WAAW,CAAC,SAAS,CAAC,EAAG,KAAK,IAAG,AAAC,EAAE,AAC3E,EAAK,OAD+E,MAClE,EAAE,CACtB,GAAW,CAAC;AAAA,KAAO,EAAE,KAAK,SAAS,CAAC,EAAK,aAAa,EAAA,CAAA,AAAG,EAEpD,CACT,GAAG,IAAI,CAAC,MAGF,EAAW,CAAC;;YAER,EAAE,EAAe,QAAQ,EAAI,MAAM;YACnC,EAAE,EAAe,QAAQ,EAAI,IAAI;YACjC,EAAE,EAAe,QAAQ,EAAI,IAAI;aAChC,EAAE,EAAe,SAAS,EAAI,IAAI;YACnC,EAAE,EAAe,aAAa,EAAI,IAAI;AAClD,CAAC,CAGC,MAAO,CAAC;;;AAGV,EAAE,YAAY;AACd,EAAE,QAAQ;AACV,EAAE,aAAa;AACf,EAAE,aAAa;AACf,EAAE,iBAAiB;AACnB,EAAE,SAAS;;;;;;;;;;;AAWX,CAAC,AACD,EApFqC,EAED,CACpC"}